<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Chat MCP - Haloscan AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        .tool-badge {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <div x-data="chatApp()" class="flex-1 flex flex-col max-w-7xl mx-auto w-full px-4 py-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        ü§ñ <span class="ml-2">Chat MCP Assistant</span>
                    </h1>
                    <p class="text-gray-600 mt-2">Assistant IA avec acc√®s aux outils Haloscan SEO</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Powered by</div>
                    <div class="font-semibold text-blue-600">OpenAI + Haloscan MCP</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex-shrink-0">
            <div class="flex space-x-4">
                <a href="/" class="px-4 py-2 text-gray-600 hover:text-blue-600 transition-colors">
                    üè† Interface Principale
                </a>
                <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg font-medium">
                    üí¨ Chat MCP
                </span>
                <button @click="showTools = !showTools" 
                        class="px-4 py-2 text-gray-600 hover:text-blue-600 transition-colors">
                    üîß Outils Disponibles
                </button>
            </div>
        </div>

        <!-- Outils disponibles (collapsible) -->
        <div x-show="showTools" x-transition class="bg-white rounded-lg shadow-sm p-4 mb-4 flex-shrink-0">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üîß Outils MCP Disponibles</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-800">üîç analyze_keyword</h4>
                    <p class="text-sm text-blue-600">Analyse compl√®te d'un mot-cl√© SEO</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-medium text-green-800">üéØ find_similar_keywords</h4>
                    <p class="text-sm text-green-600">Trouve des mots-cl√©s similaires</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-800">üåê analyze_domain</h4>
                    <p class="text-sm text-purple-600">Analyse compl√®te d'un domaine</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg">
                    <h4 class="font-medium text-orange-800">‚öîÔ∏è find_domain_competitors</h4>
                    <p class="text-sm text-orange-600">Trouve les concurrents d'un domaine</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg">
                    <h4 class="font-medium text-red-800">üìä search_keywords_by_position</h4>
                    <p class="text-sm text-red-600">Recherche avanc√©e par position</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-800">üí≥ get_user_credits</h4>
                    <p class="text-sm text-gray-600">V√©rifie les cr√©dits disponibles</p>
                </div>
            </div>
        </div>

        <!-- Zone de chat -->
        <div class="bg-white rounded-lg shadow-sm flex flex-col flex-1 min-h-0">
            <!-- Messages -->
            <div class="flex-1 p-6 overflow-y-auto space-y-4" id="chatMessages">
                <!-- Message de bienvenue -->
                <div class="chat-message flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ü§ñ
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-gray-800">
                                Bonjour ! üëã Je suis votre assistant SEO IA avec acc√®s aux outils Haloscan.
                                <br><br>
                                <strong>Exemples de questions :</strong>
                                <br>‚Ä¢ "Analyse le mot-cl√© 'marketing digital'"
                                <br>‚Ä¢ "Trouve les concurrents de example.com"
                                <br>‚Ä¢ "Quels sont mes cr√©dits Haloscan ?"
                                <br>‚Ä¢ "Cherche les mots-cl√©s de mon-site.fr en positions 1-5"
                            </p>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">Assistant MCP</div>
                    </div>
                </div>

                <!-- Messages dynamiques -->
                <template x-for="message in messages" :key="message.id">
                    <div class="chat-message flex items-start space-x-3">
                        <!-- Avatar utilisateur -->
                        <div x-show="message.role === 'user'" class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            üë§
                        </div>
                        <!-- Avatar assistant -->
                        <div x-show="message.role === 'assistant'" class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            ü§ñ
                        </div>
                        
                        <div class="flex-1">
                            <!-- Message utilisateur -->
                            <div x-show="message.role === 'user'" class="bg-green-50 rounded-lg p-4">
                                <p class="text-gray-800" x-text="message.content"></p>
                            </div>
                            
                            <!-- Message assistant -->
                            <div x-show="message.role === 'assistant'" class="bg-blue-50 rounded-lg p-4">
                                <div x-html="formatMessage(message.content)"></div>
                                
                                <!-- Outils utilis√©s -->
                                <div x-show="message.tools_used && message.tools_used.length > 0" class="mt-3 pt-3 border-t border-blue-200">
                                    <div class="text-sm font-medium text-blue-800 mb-2">üîß Outils utilis√©s :</div>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="tool in message.tools_used">
                                            <span class="tool-badge inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="tool.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                <span x-text="tool.tool"></span>
                                                <span x-show="tool.success" class="ml-1">‚úÖ</span>
                                                <span x-show="!tool.success" class="ml-1">‚ùå</span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-500 mt-2" x-text="message.role === 'user' ? 'Vous' : 'Assistant MCP'"></div>
                        </div>
                    </div>
                </template>

                <!-- Indicateur de frappe -->
                <div x-show="isTyping" class="chat-message flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ü§ñ
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="typing-indicator flex space-x-1">
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">L'assistant r√©fl√©chit...</div>
                    </div>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div class="border-t border-gray-200 p-4 flex-shrink-0">
                <form @submit.prevent="sendMessage()" class="flex space-x-4">
                    <input 
                        x-model="currentMessage"
                        type="text" 
                        placeholder="Posez votre question SEO... (ex: 'Analyse le mot-cl√© marketing digital')"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                        :disabled="isTyping"
                        x-ref="messageInput"
                        @keydown.enter="sendMessage()"
                    >
                    <button 
                        type="submit"
                        :disabled="isTyping || !currentMessage.trim()"
                        class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                    >
                        <span x-show="!isTyping">üì§ Envoyer</span>
                        <span x-show="isTyping">‚è≥ ...</span>
                    </button>
                </form>
                
                <!-- Exemples rapides -->
                <div class="mt-3 flex flex-wrap gap-2">
                    <button @click="currentMessage = 'Analyse le mot-cl√© marketing digital'; sendMessage()" 
                            class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
                        üîç Analyse mot-cl√©
                    </button>
                    <button @click="currentMessage = 'Trouve les concurrents de lemonde.fr'; sendMessage()" 
                            class="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors">
                        ‚öîÔ∏è Concurrents
                    </button>
                    <button @click="currentMessage = 'Quels sont mes cr√©dits Haloscan ?'; sendMessage()" 
                            class="text-xs px-3 py-1 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition-colors">
                        üí≥ Cr√©dits
                    </button>
                    <button @click="currentMessage = 'Cherche les mots-cl√©s de lemonde.fr en positions 1-5'; sendMessage()" 
                            class="text-xs px-3 py-1 bg-orange-100 text-orange-700 rounded-full hover:bg-orange-200 transition-colors">
                        üìä Positions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                messages: [],
                currentMessage: '',
                isTyping: false,
                showTools: false,
                messageId: 1,

                async sendMessage() {
                    if (!this.currentMessage.trim() || this.isTyping) return;

                    const userMessage = {
                        id: this.messageId++,
                        role: 'user',
                        content: this.currentMessage,
                        tools_used: []
                    };

                    this.messages.push(userMessage);
                    const messageToSend = this.currentMessage;
                    this.currentMessage = '';
                    this.isTyping = true;

                    // Scroll vers le bas
                    this.$nextTick(() => {
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });

                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: messageToSend,
                                conversation_history: this.messages.slice(0, -1).map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                }))
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }

                        const data = await response.json();

                        const assistantMessage = {
                            id: this.messageId++,
                            role: 'assistant',
                            content: data.response,
                            tools_used: data.tools_used || []
                        };

                        this.messages.push(assistantMessage);

                    } catch (error) {
                        console.error('Erreur lors de l\'envoi du message:', error);
                        
                        const errorMessage = {
                            id: this.messageId++,
                            role: 'assistant',
                            content: `‚ùå D√©sol√©, une erreur s'est produite : ${error.message}`,
                            tools_used: []
                        };

                        this.messages.push(errorMessage);
                    } finally {
                        this.isTyping = false;
                        
                        // Scroll vers le bas
                        this.$nextTick(() => {
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        });
                    }
                },

                formatMessage(content) {
                    // Formatage basique du markdown
                    return content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>')
                        .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>');
                }
            }
        }
    </script>
</body>
</html>
