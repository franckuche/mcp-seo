<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat MCP avec Chunking Intelligent - Haloscan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div class="h-full flex flex-col" x-data="chatApp()">
        <!-- Header Compact -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">üß† Chat MCP Chunked</h1>
                    <p class="text-sm text-gray-600">Analyses SEO compl√®tes sans limite de tokens</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-xs text-gray-500">Mode:</span>
                    <span class="text-sm font-semibold text-blue-600">üß† Chunking Intelligent</span>
                </div>
            </div>
        </div>

        <!-- Chat Area Plein √âcran -->
        <div class="flex-1 bg-white flex flex-col min-h-0">
            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4" id="messages">
                <!-- Message d'accueil -->
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ü§ñ
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-gray-800">
                                Bonjour ! üëã Je suis votre assistant SEO IA avec <strong>chunking intelligent</strong>.
                            </p>
                            <div class="mt-3 text-sm text-gray-600">
                                <p><strong>Mode Chunking Intelligent :</strong> Pour des analyses compl√®tes, utilisez des phrases comme :</p>
                                <ul class="mt-2 space-y-1">
                                    <li>‚Ä¢ "Analyse compl√®te de ads-up.fr et tous ses concurrents"</li>
                                    <li>‚Ä¢ "Rapport d√©taill√© sur lemonde.fr avec analyse exhaustive"</li>
                                    <li>‚Ä¢ "Audit complet de mon-site.com avec tous les mots-cl√©s"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages dynamiques -->
                <template x-for="message in messages" :key="message.id">
                    <div class="flex items-start space-x-3" :class="message.role === 'user' ? 'flex-row-reverse space-x-reverse' : ''">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                             :class="message.role === 'user' ? 'bg-green-500' : 'bg-blue-500'">
                            <span x-text="message.role === 'user' ? 'üë§' : 'ü§ñ'"></span>
                        </div>
                        <div class="flex-1 max-w-4xl">
                            <div class="rounded-lg p-4" 
                                 :class="message.role === 'user' ? 'bg-green-50' : 'bg-blue-50'">
                                <div x-html="formatMessage(message.content)"></div>
                                
                                <!-- Outils utilis√©s -->
                                <div x-show="message.tools_used && message.tools_used.length > 0" class="mt-3 pt-3 border-t border-gray-200">
                                    <p class="text-xs text-gray-500 mb-2">üîß Outils utilis√©s :</p>
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="tool in message.tools_used">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="tool.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                <span x-text="tool.success ? '‚úÖ' : '‚ùå'"></span>
                                                <span x-text="tool.tool" class="ml-1"></span>
                                                <span x-show="tool.chunks_processed" x-text="'(' + tool.chunks_processed + ' chunks)'" class="ml-1 text-blue-600 font-bold"></span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Loading indicator -->
                <div x-show="isLoading" class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ü§ñ
                    </div>
                    <div class="flex-1">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                                <span x-text="loadingMessage" class="text-gray-700"></span>
                            </div>
                            
                            <!-- Progression du chunking intelligent -->
                            <div x-show="showChunkingProgress" class="mt-4">
                                <div class="flex justify-between items-center mb-3">
                                    <p class="text-xs text-gray-500">üß† √âtapes du chunking intelligent :</p>
                                    <div class="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                        <span x-text="`‚è±Ô∏è ${elapsedTime}s / ~${totalEstimatedTime}s`"></span>
                                        <span x-show="remainingTime > 0" class="ml-2 text-blue-600">
                                            (encore ~<span x-text="remainingTime"></span>s)
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Barre de progression globale -->
                                <div class="mb-3">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" 
                                             :style="`width: ${Math.min(100, (elapsedTime / totalEstimatedTime) * 100)}%`"></div>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <template x-for="(step, index) in chunkingSteps" :key="index">
                                        <div class="flex items-center space-x-2 text-sm">
                                            <div class="w-4 h-4 rounded-full flex items-center justify-center text-xs"
                                                 :class="{
                                                     'bg-gray-200 text-gray-500': step.status === 'pending',
                                                     'bg-blue-500 text-white animate-pulse': step.status === 'active',
                                                     'bg-green-500 text-white': step.status === 'completed'
                                                 }">
                                                <span x-show="step.status === 'pending'">‚Ä¢</span>
                                                <span x-show="step.status === 'active'">‚è≥</span>
                                                <span x-show="step.status === 'completed'">‚úì</span>
                                            </div>
                                            <span x-text="step.name" 
                                                  :class="{
                                                      'text-gray-500': step.status === 'pending',
                                                      'text-blue-600 font-medium': step.status === 'active',
                                                      'text-green-600': step.status === 'completed'
                                                  }"></span>
                                            <span x-show="step.status === 'active'" class="text-xs text-blue-500 ml-auto">
                                                (~<span x-text="step.duration"></span>s)
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area Fixe en Bas -->
            <div class="border-t border-gray-200 p-4 flex-shrink-0 bg-gray-50">
                <!-- Quick Examples -->
                <div class="mb-3">
                    <p class="text-xs text-gray-500 mb-2">Exemples rapides :</p>
                    <div class="flex flex-wrap gap-2">
                        <button @click="setMessage('ANALYSE SEO CHUNKED: https://ads-up.fr/\nMISSION: Identifier les mots-cl√©s o√π ads-up.fr NE SE POSITIONNE PAS mais o√π la plupart de ses concurrents sont bien positionn√©s (pages 1-3).')" 
                                class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200 transition-colors">
                            üß† Gaps SEO ads-up.fr
                        </button>
                        <button @click="setMessage('ANALYSE SEO CHUNKED: https://lemonde.fr/\nMISSION: Rapport d√©taill√© avec analyse exhaustive des mots-cl√©s et concurrents.')" 
                                class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200 transition-colors">
                            üìä Analyse lemonde.fr
                        </button>
                        <button @click="setMessage('Quels sont mes cr√©dits Haloscan ?')" 
                                class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200 transition-colors">
                            üí≥ Cr√©dits Haloscan
                        </button>
                    </div>
                </div>

                <!-- Input Form -->
                <form @submit.prevent="sendMessage" class="space-y-3">
                    <div class="flex flex-col space-y-2">
                        <textarea x-model="currentMessage" 
                                  placeholder="Tapez votre prompt SEO d√©taill√©...&#10;&#10;Exemple:&#10;ANALYSE SEO CHUNKED: https://ads-up.fr/&#10;MISSION: Identifier les mots-cl√©s o√π ads-up.fr NE SE POSITIONNE PAS mais o√π la plupart de ses concurrents sont bien positionn√©s..."
                                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base resize-none transition-all duration-200"
                                  :disabled="isLoading"
                                  rows="4"
                                  x-ref="messageTextarea"
                                  @input="autoResize()"
                                  @keydown.ctrl.enter="sendMessage()"
                                  style="min-height: 100px; max-height: 300px;"></textarea>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>Ctrl+Entr√©e pour envoyer | Le textarea s'agrandit automatiquement</span>
                            <span x-text="`${currentMessage.length} caract√®res`"></span>
                        </div>
                    </div>
                    <button type="submit" 
                            :disabled="isLoading || !currentMessage.trim()"
                            class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors">
                        <span x-show="!isLoading">üöÄ Lancer l'analyse SEO chunked</span>
                        <span x-show="isLoading">üß† Analyse en cours...</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                messages: [],
                currentMessage: '',
                isLoading: false,
                loadingMessage: 'Analyse en cours...',
                mode: 'chunked', // Par d√©faut en mode chunked
                showChunkingProgress: false,
                chunkingSteps: [],
                currentStep: 0,
                
                setMessage(message) {
                    this.currentMessage = message;
                    // Auto-resize le textarea apr√®s avoir d√©fini le message
                    this.$nextTick(() => this.autoResize());
                },
                
                autoResize() {
                    // Fonction pour redimensionner automatiquement le textarea
                    const textarea = this.$refs.messageTextarea;
                    if (textarea) {
                        // Reset la hauteur pour calculer la nouvelle hauteur
                        textarea.style.height = 'auto';
                        
                        // Calculer la nouvelle hauteur bas√©e sur le contenu
                        const newHeight = Math.min(Math.max(textarea.scrollHeight, 100), 300);
                        textarea.style.height = newHeight + 'px';
                    }
                },
                
                async sendMessage() {
                    if (!this.currentMessage.trim() || this.isLoading) return;
                    
                    const userMessage = this.currentMessage.trim();
                    this.currentMessage = '';
                    
                    // Ajouter le message utilisateur
                    this.messages.push({
                        id: Date.now(),
                        role: 'user',
                        content: userMessage,
                        tools_used: []
                    });
                    
                    this.isLoading = true;
                    
                    // D√©terminer le message de chargement selon le mode
                    if (this.mode === 'chunked' && this.isComplexQuery(userMessage)) {
                        this.loadingMessage = 'üß† Analyse chunked en cours...';
                        this.showChunkingProgress = true;
                        this.chunkingSteps = [
                            { name: 'üìä Analyse du domaine', status: 'pending', duration: 3 },
                            { name: 'üè¢ Identification des concurrents', status: 'pending', duration: 4 },
                            { name: 'üîç Analyse mots-cl√©s page 2 (11-20)', status: 'pending', duration: 8 },
                            { name: 'üìà Analyse mots-cl√©s page 1 (1-10)', status: 'pending', duration: 6 },
                            { name: 'üìä Analyse mots-cl√©s page 3+ (21-50)', status: 'pending', duration: 10 },
                            { name: 'üß† Synth√®se finale (max 8000 tokens)', status: 'pending', duration: 15 }
                        ];
                        this.currentStep = 0;
                        this.totalEstimatedTime = this.chunkingSteps.reduce((sum, step) => sum + step.duration, 0);
                        this.startProgressSimulation();
                    } else {
                        this.loadingMessage = 'ü§ñ Analyse en cours...';
                        this.showChunkingProgress = false;
                    }
                    
                    // Scroll vers le bas
                    this.$nextTick(() => {
                        const messagesDiv = document.getElementById('messages');
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    });
                    
                    try {
                        // FORCER l'endpoint chunked sur cette interface
                        const endpoint = '/api/chat-chunked';
                        
                        // DEBUG: Afficher l'endpoint utilis√©
                        console.log('üéØ INTERFACE: chat-chunked | ENDPOINT FORC√â:', endpoint);
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: userMessage,
                                conversation_history: this.messages.slice(0, -1).map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                }))
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Ajouter la r√©ponse de l'assistant
                        this.messages.push({
                            id: Date.now() + 1,
                            role: 'assistant',
                            content: data.response,
                            tools_used: data.tools_used || []
                        });
                        
                    } catch (error) {
                        console.error('Erreur lors de l\'envoi du message:', error);
                        this.messages.push({
                            id: Date.now() + 1,
                            role: 'assistant',
                            content: `‚ùå D√©sol√©, une erreur s'est produite : ${error.message}`,
                            tools_used: []
                        });
                    } finally {
                        this.isLoading = false;
                        
                        // Scroll vers le bas
                        this.$nextTick(() => {
                            const messagesDiv = document.getElementById('messages');
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        });
                    }
                },
                
                startProgressSimulation() {
                    // D√©marrer la simulation de progression avec timer r√©aliste
                    this.progressStartTime = Date.now();
                    this.elapsedTime = 0;
                    this.remainingTime = this.totalEstimatedTime;
                    
                    // Mettre la premi√®re √©tape en actif
                    if (this.chunkingSteps.length > 0) {
                        this.chunkingSteps[0].status = 'active';
                    }
                    
                    // Timer pour mettre √† jour le temps √©coul√©/restant
                    this.progressTimer = setInterval(() => {
                        if (this.isLoading) {
                            this.elapsedTime = Math.floor((Date.now() - this.progressStartTime) / 1000);
                            this.remainingTime = Math.max(0, this.totalEstimatedTime - this.elapsedTime);
                        } else {
                            clearInterval(this.progressTimer);
                        }
                    }, 1000);
                    
                    // Simuler la progression des √©tapes
                    this.simulateStepProgression();
                },
                
                simulateStepProgression() {
                    let cumulativeTime = 0;
                    
                    this.chunkingSteps.forEach((step, index) => {
                        cumulativeTime += step.duration;
                        
                        setTimeout(() => {
                            if (this.isLoading && this.currentStep === index) {
                                // Compl√©ter l'√©tape actuelle
                                this.chunkingSteps[index].status = 'completed';
                                this.currentStep++;
                                
                                // Activer la prochaine √©tape si elle existe
                                if (this.currentStep < this.chunkingSteps.length) {
                                    this.chunkingSteps[this.currentStep].status = 'active';
                                } else {
                                    // Toutes les √©tapes sont termin√©es
                                    this.showChunkingProgress = false;
                                    clearInterval(this.progressTimer);
                                }
                            }
                        }, cumulativeTime * 1000);
                    });
                },
                
                isComplexQuery(message) {
                    // TOUJOURS activer le chunking sur l'interface /chat-chunked
                    return true;
                    
                    // Ancienne logique de d√©tection (d√©sactiv√©e)
                    /*
                    const complexKeywords = [
                        'analyse compl√®te', 'analyse d√©taill√©e', 'tous les concurrents', 
                        'analyse exhaustive', '√©tude approfondie', 'rapport complet',
                        'tous les mots-cl√©s', 'analyse concurrentielle', 'audit complet',
                        'chunked', 'seo chunked', 'analyse seo chunked'
                    ];
                    return complexKeywords.some(keyword => message.toLowerCase().includes(keyword));
                    */
                },
                
                formatMessage(content) {
                    // Convertir les retours √† la ligne en <br>
                    return content.replace(/\n/g, '<br>');
                }
            }
        }
    </script>
</body>
</html>
